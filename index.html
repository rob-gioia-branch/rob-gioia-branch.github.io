<!DOCTYPE html>
<html> 
  <head>
    
    <!-- Google Tag Manager -->
      <!-- <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-P56738MR');</script> -->
    <!-- End Google Tag Manager -->
    <script> 
         // Function to ensure Branch SDK is loaded and stubbed (your existing script loader)
(function(b,r,a,n,c,h,_,s,d,k){if(!b[n]||!b[n]._q){for(;s<_.length;)c(h,_[s++]);d=r.createElement(a);d.async=1;d.src="https://cdn.branch.io/branch-latest.min.js";k=r.getElementsByTagName(a)[0];k.parentNode.insertBefore(d,k);b[n]=h}})(window,document,"script","branch",function(b,r){b[r]=function(){b._q.push([r,arguments])}},{_q:[],_v:1},"addListener banner closeBanner closeJourney closeView data deepview deepviewCta first init link logout removeListener setBranchViewData setIdentity track trackCommerceEvent logEvent disableTracking getBrowserFingerprintId crossPlatformIds lastAttributedTouchData setAPIResponseCallback qrCode".split(" "), 0);
         
  // 1. Set the user ID first
  branch.setIdentity("rob-user-id");

  // 2. Initialize Branch and pass the custom data in the `init` options
  // This data will be automatically included in any deep link created by Branch (e.g., Journey CTA link)
  branch.init('key_live_mbErCMtrzeheAWS0Xagg7hjbwDkaZ6SP', {
      // This is the data object that will be attached to the deep link
      data: {
          id: 'rob-user-id',
          example: 'example-value'
      },
      // The `listen` option ensures Journeys/Branch Views are displayed
      listen: true 
  }, function(err, data) {
      if (err) {
          // Handle initialization error
          console.error('Branch Init Error:', err);
          return;
      }
      // Initialization success, and Journeys should be ready to display
      console.log('Branch Init Data:', data);
  });
         // init Branch
         
         
        //  window.onload = function(e){ 
        //    window.myRoutingData = {
        //     routingData: 'value_for_deep_linking_from_window',
        //     userId: 'my_user_id_from_window'
        //    };
          
        //   if (window.myRoutingData && typeof branch !== 'undefined') {
        //        const dynamicData = window.myRoutingData;
        //       'routingData': dynamicData.routingData,
        //       'userId': dynamicData.userId 
        //   };

        //   branch.setBranchViewData({
        //     data: deepLinkData
        //   });
        // }
          // setTimeout(() => {
            
            
          // }, 100);
        }
    </script>
  </head>
  <body>
    <!-- Google Tag Manager (noscript) -->
      <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P56738MR"
      height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <h1 id="page1-h1"> Page 1 </h1>
    <h2 id="page1-h2"> non-SPA </h2>
    <button id="load-spa" type="button" onclick="handleLoadSPAButtonClicked()">Load SPA page</button>
    <button id="load-regular" type="button" onclick="window.location.href = 'https://rob-gioia-branch.github.io/page2.html'">Load regular page</button>
    <button id="back-button-1" type="button" onclick="handleBackButtonClicked()">Back</button> <!-- hidden if first page -->
    <script>
      var isSPAPage = false; 

      // function closeBranchJourney() {
      //   console.info("[branch.io] closeJourney is called");
      //   window.branch.closeJourney((err) => {
      //     if (err) {
      //       console.error("[branch.io] Fails to close the Journey: ", err);
      //     }
      //     else {
      //       setTimeout(() => {
      //         // reopen
      //         console.info("[branch.io] pageview is called");
      //         window.branch.track("pageview", (err) => {
      //           if (err) {
      //             console.error("[branch.io] Fails to show the Journey:", err);
      //           }
      //         })
      //       }, 500)
      //     }
      //   });
      // }
        
      function handleBackButtonClicked() {
        if(isSPAPage) {
          isSPAPage = false;
          document.getElementById('load-spa').style.visibility= "visible";
          document.getElementById('page1-h1').innerHTML = "Page 1";
          document.getElementById('page1-h2').innerHTML = "non-SPA";
          window.history.replaceState(null, null, "index.html");
          //closeBranchJourney();
          dataLayer.push({'event': 'TRIGGER_SPA_CODE'});
        }
      }

      function handleLoadSPAButtonClicked() {
        if(!isSPAPage) {
          isSPAPage = true;
          document.getElementById('load-spa').style.visibility= "hidden";
          document.getElementById('page1-h1').innerHTML = "Page 1";
          document.getElementById('page1-h2').innerHTML = " current: SPA | prior:non-SPA";
          window.history.replaceState(null, null, "page1-spa");
          //closeBranchJourney();
          dataLayer.push({'event': 'TRIGGER_SPA_CODE'});
        }
      }
    </script>
  </body>
</html>
