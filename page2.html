<!DOCTYPE html>
<html> 
  <head>
    <script> 
       // load Branch
         (function(b,r,a,n,c,h,_,s,d,k){if(!b[n]||!b[n]._q){for(;s<_.length;)c(h,_[s++]);d=r.createElement(a);d.async=1;d.src="https://cdn.branch.io/branch-latest.min.js";k=r.getElementsByTagName(a)[0];k.parentNode.insertBefore(d,k);b[n]=h}})(window,document,"script","branch",function(b,r){b[r]=function(){b._q.push([r,arguments])}},{_q:[],_v:1},"addListener banner closeBanner closeJourney data deepview deepviewCta first init link logout removeListener setBranchViewData setIdentity track trackCommerceEvent logEvent disableTracking getBrowserFingerprintId crossPlatformIds lastAttributedTouchData setAPIResponseCallback qrCode".split(" "), 0);
         // init Branch
         branch.init('key_live_alXEebrYD6sXYsXfU8PREhnhzrcWdEN8');
         window.onload = function(e){ 
          setTimeout(() => {
            closeBranchJourney();
          }, 250);
        }
    </script>
  </head>
  <body>
    <h1 id="page2-h1"> Page 2 </h1>
    <h2 id="page2-h2"> non-SPA </h2>
    <button id="load-spa-2" onclick="handleLoadSPAButtonClicked()" type="button">Load SPA page</button>
    <button id="back-button-2" onclick="handleBackButtonClicked()" type="button">Back</button>
    <script>
      var isSPAPage = false; 
      var isSecondSPAPage = false;

      function closeBranchJourney() {
        console.info("[branch.io] closeJourney is called");
        window.branch.closeJourney((err) => {
          if (err) {
            console.error("[branch.io] Fails to close the Journey: ", err);
          }
          else {
            setTimeout(() => {
              // reopen
              console.info("[branch.io] pageview is called");
              window.branch.track("pageview", (err) => {
                if (err) {
                  console.error("[branch.io] Fails to show the Journey:", err);
                }
              })
            }, 500)
          }
        });
      }
      
      function handleBackButtonClicked() {
        if(isSPAPage) {
          if(!isSecondSPAPage) {
            isSPAPage = false;
            document.getElementById('page2-h2').innerHTML = "non-SPA";
            window.history.replaceState(null, null, "page2.html");
          } else {
            isSecondSPAPage = false;
            isSPAPage = true;
            document.getElementById('page2-h2').innerHTML = "SPA";
            document.getElementById('page2-h1').innerHTML = "Page 2";
            window.history.replaceState(null, null, "page2-spa");
          }
          closeBranchJourney();
        } else {
          window.location.href = 'https://rob-gioia-branch.github.io/index.html'
        }
      }

      function handleLoadSPAButtonClicked() {
        if(!isSPAPage) {
          isSPAPage = true;
          document.getElementById('page2-h2').innerHTML = " current: SPA | prior:non-SPA";
          window.history.replaceState(null, null, "page2-spa");
        } else {
          isSecondSPAPage = true;
          document.getElementById('page2-h1').innerHTML = "Page 3";
          document.getElementById('page2-h2').innerHTML = " current: SPA | prior:SPA";
          window.history.replaceState(null, null, "page3-spa");
        }
        closeBranchJourney();
      }  
    </script>
  </body>
</html>
